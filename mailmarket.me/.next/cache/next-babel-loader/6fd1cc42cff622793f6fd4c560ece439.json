{"ast":null,"code":"import { Base64 } from \"js-base64\";\nimport nodemailer from \"nodemailer\";\nimport mongodb from \"mongodb\";\nimport path from \"path\";\nimport fs from \"fs\";\nconst MongoClient = mongodb.MongoClient;\nconst {\n  serverRuntimeConfig\n} = getConfig();\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\nconst client = new MongoClient(uri, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\nconst defaultMailList = fs.readFileSync(path.join(serverRuntimeConfig.PROJECT_ROOT, \"./emailer/email-list.txt\"), (err, res) => {\n  console.log(res);\n});\nconsole.log(defaultMailList);\nconst transporter = nodemailer.createTransport({\n  service: \"gmail\",\n  auth: {\n    user: \"robertlostsworen@gmail.com\",\n    pass: \"robertlostsworenismyname!\"\n  }\n});\nexport default ((req, res) => {\n  if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null) {\n    client.connect(err => {\n      if (err) throw err;\n      const db = client.db(\"MailMarketMe\");\n      db.collection(\"accounts\").findOne({\n        _id: mongodb.ObjectId(Base64.decode(req.body.id))\n      }, (err, result) => {\n        if (req.body.pointsToUse <= result.points) {\n          db.collection(\"accounts\").updateOne({\n            _id: mongodb.ObjectId(Base64.decode(req.body.id))\n          }, {\n            $set: {\n              points: result.points - req.body.pointsToUse,\n              totalEmailsSent: req.body.pointsToUse\n            }\n          });\n          let emails;\n\n          if (req.body.customEmailList.length > 0) {\n            emails = req.body.customEmailList.replace(\" \", \"\").split(\",\");\n          } else {\n            emails = [];\n          } // Send the emails\n\n\n          res.status(200).end();\n        } else {\n          res.status(406).end();\n        }\n      });\n    });\n  } else {\n    res.status(406).end();\n  }\n});","map":null,"metadata":{},"sourceType":"module"}