{"ast":null,"code":"import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\nconst client = new MongoClient(uri, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\nconst mailerClient = simplesmtp.Mail({\n  host: \"mbox.contact.bg\",\n  port: 25,\n  secure: false,\n  username: \"mailmarketme@mbox.contact.bg\",\n  password: \"09730Success\"\n});\n\nfunction findEmailAddresses(StrObj) {\n  var separateEmailsBy = \", \";\n  var email = \"<none>\"; // if no match, use this\n\n  var emailsArray = StrObj.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\\\.[a-zA-Z0-9._-]+)/gi);\n\n  if (emailsArray) {\n    email = \"\";\n\n    for (var i = 0; i < emailsArray.length; i++) {\n      if (i != 0) email += separateEmailsBy;\n      email += emailsArray[i];\n    }\n  }\n\n  return email;\n}\n\nfunction shuffle(array) {\n  var currentIndex = array.length,\n      temporaryValue,\n      randomIndex; // While there remain elements to shuffle...\n\n  while (0 !== currentIndex) {\n    // Pick a remaining element...\n    randomIndex = Math.floor(Math.random() * currentIndex);\n    currentIndex -= 1; // And swap it with the current element.\n\n    temporaryValue = array[currentIndex];\n    array[currentIndex] = array[randomIndex];\n    array[randomIndex] = temporaryValue;\n  }\n\n  return array;\n}\n\nlet mailArray = [];\nclient.connect(err => {\n  if (err) throw err;\n  const db = client.db(\"MailMarketMe\");\n  let mailsToSend = db.collection(\"emails\").find({});\n  mailsToSend.toArray().then(result => {\n    result.forEach(data => {\n      mailArray.push(data.email);\n    });\n    console.log(mailArray.filter(Boolean));\n  });\n});\nexport default ((req, res) => {\n  if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n    client.connect(err => {\n      if (err) throw err;\n      const db = client.db(\"MailMarketMe\");\n      db.collection(\"accounts\").findOne({\n        _id: mongodb.ObjectId(Base64.decode(req.body.id))\n      }, (err, result) => {\n        if (req.body.pointsToUse <= result.points) {\n          db.collection(\"accounts\").updateOne({\n            _id: mongodb.ObjectId(Base64.decode(req.body.id))\n          }, {\n            $set: {\n              points: result.points - req.body.pointsToUse,\n              totalEmailsSent: parseInt(req.body.pointsToUse) + parseInt(result.totalEmailsSent)\n            }\n          }, err => {\n            if (err) throw err;\n          });\n\n          for (let i = 0; i < req.body.pointsToUse; i++) {}\n\n          ; // Send the emails \n\n          res.status(200).end();\n        } else {\n          res.status(406).end();\n        }\n      });\n    });\n  } else {\n    res.status(406).end();\n  }\n});","map":null,"metadata":{},"sourceType":"module"}