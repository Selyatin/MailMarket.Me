{"ast":null,"code":"import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\nconst client = new MongoClient(uri, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\nconst mailerClient = simplesmtp.Mail({\n  host: \"mbox.contact.bg\",\n  port: 25,\n  secure: false,\n  username: \"mailmarketme@mbox.contact.bg\",\n  password: \"09730Success\"\n});\n\nfunction findEmailAddresses(StrObj) {\n  var separateEmailsBy = \", \";\n  var email = \"<none>\"; // if no match, use this\n\n  var emailsArray = StrObj.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\\\.[a-zA-Z0-9._-]+)/gi);\n\n  if (emailsArray) {\n    email = \"\";\n\n    for (var i = 0; i < emailsArray.length; i++) {\n      if (i != 0) email += separateEmailsBy;\n      email += emailsArray[i];\n    }\n  }\n\n  return email;\n}\n\nfunction shuffle(array) {\n  var currentIndex = array.length,\n      temporaryValue,\n      randomIndex; // While there remain elements to shuffle...\n\n  while (0 !== currentIndex) {\n    // Pick a remaining element...\n    randomIndex = Math.floor(Math.random() * currentIndex);\n    currentIndex -= 1; // And swap it with the current element.\n\n    temporaryValue = array[currentIndex];\n    array[currentIndex] = array[randomIndex];\n    array[randomIndex] = temporaryValue;\n  }\n\n  return array;\n}\n\nexport default ((req, res) => {\n  if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n    client.connect(err => {\n      if (err) throw err;\n      const db = client.db(\"MailMarketMe\");\n      db.collection(\"accounts\").findOne({\n        _id: mongodb.ObjectId(Base64.decode(req.body.id))\n      }, (err, result) => {\n        if (req.body.pointsToUse <= result.points) {\n          db.collection(\"accounts\").updateOne({\n            _id: mongodb.ObjectId(Base64.decode(req.body.id))\n          }, {\n            $set: {\n              points: result.points - req.body.pointsToUse,\n              totalEmailsSent: req.body.pointsToUse + result.totalEmailsSent\n            }\n          }, err => {\n            if (err) throw err;\n          });\n          let mailsToSend = db.collection(\"emails\").find({}).limit(100);\n          let customEmailList = findEmailAddresses(req.body.customEmailList);\n          console.log(customEmailList);\n          console.log(req.body.customEmailList.split(\"\\n\"));\n          let mailList = [];\n          mailList = mailList.concat(customEmailList, mailsToSend); // mailerClient.message({\n          //     from: req.body.from,\n          //     to: mailList,\n          //     subject: req.body.subject,\n          //     \"Content-type\": \"text/html\",\n          // }).body(req.body.msgToSend).send(err => console.log(err));\n          // Send the emails \n\n          res.status(200).end();\n        } else {\n          res.status(406).end();\n        }\n      });\n    });\n  } else {\n    res.status(406).end();\n  }\n});","map":{"version":3,"sources":["/Users/mac/Desktop/Web Apps/MailMarket.me/mailmarket.me/pages/api/mailer.js"],"names":["Base64","mongodb","simplesmtp","MongoClient","uri","client","useNewUrlParser","useUnifiedTopology","mailerClient","Mail","host","port","secure","username","password","findEmailAddresses","StrObj","separateEmailsBy","email","emailsArray","match","i","length","shuffle","array","currentIndex","temporaryValue","randomIndex","Math","floor","random","req","res","method","body","id","undefined","pointsToUse","customEmailList","msgToSend","from","connect","err","db","collection","findOne","_id","ObjectId","decode","result","points","updateOne","$set","totalEmailsSent","mailsToSend","find","limit","console","log","split","mailList","concat","status","end"],"mappings":"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","sourcesContent":["import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\n\nconst client = new MongoClient(uri, { useNewUrlParser: true, useUnifiedTopology: true });\n\nconst mailerClient = simplesmtp.Mail({\n    host: \"mbox.contact.bg\",\n    port: 25,\n    secure: false,\n    username: \"mailmarketme@mbox.contact.bg\",\n    password: \"09730Success\",\n})\n\nfunction findEmailAddresses(StrObj) {\n    var separateEmailsBy = \", \";\n    var email = \"<none>\"; // if no match, use this\n    var emailsArray = StrObj.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\\\.[a-zA-Z0-9._-]+)/gi);\n    if (emailsArray) {\n        email = \"\";\n        for (var i = 0; i < emailsArray.length; i++) {\n            if (i != 0) email += separateEmailsBy;\n            email += emailsArray[i];\n        }\n    }\n    return email;\n}\n\nfunction shuffle(array) {\n    var currentIndex = array.length, temporaryValue, randomIndex;\n  \n    // While there remain elements to shuffle...\n    while (0 !== currentIndex) {\n  \n      // Pick a remaining element...\n      randomIndex = Math.floor(Math.random() * currentIndex);\n      currentIndex -= 1;\n  \n      // And swap it with the current element.\n      temporaryValue = array[currentIndex];\n      array[currentIndex] = array[randomIndex];\n      array[randomIndex] = temporaryValue;\n    }\n  \n    return array;\n  }\n\nexport default (req, res) => {\n    if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n        client.connect(err => {\n            if (err) throw err;\n            const db = client.db(\"MailMarketMe\");\n            db.collection(\"accounts\").findOne({ _id: mongodb.ObjectId(Base64.decode(req.body.id)) }, (err, result) => {\n                if (req.body.pointsToUse <= result.points) {\n                    db.collection(\"accounts\").updateOne({ _id: mongodb.ObjectId(Base64.decode(req.body.id)) },\n                        {\n                            $set: {\n                                points: result.points - req.body.pointsToUse,\n                                totalEmailsSent: req.body.pointsToUse + result.totalEmailsSent\n                            }\n                        },\n                        err => { if (err) throw err }\n                    );\n\n                    let mailsToSend = db.collection(\"emails\").find({}).limit(100);\n                    let customEmailList = findEmailAddresses(req.body.customEmailList);\n                    console.log(customEmailList);\n                    console.log(req.body.customEmailList.split(\"\\n\"));\n                    \n                    let mailList = [];\n                    mailList = mailList.concat(customEmailList, mailsToSend);\n                    // mailerClient.message({\n                    //     from: req.body.from,\n                    //     to: mailList,\n                    //     subject: req.body.subject,\n                    //     \"Content-type\": \"text/html\",\n                    // }).body(req.body.msgToSend).send(err => console.log(err));\n                        \n                        // Send the emails \n                        res.status(200).end();\n                    }else {\n                        res.status(406).end();\n                    }\n        });\n        });\n    }\n    else {\n        res.status(406).end();\n    }\n}"]},"metadata":{},"sourceType":"module"}