{"ast":null,"code":"import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\nconst client = new MongoClient(uri, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\nconst mailerClient = simplesmtp.Mail({\n  host: \"mbox.contact.bg\",\n  port: 25,\n  secure: false,\n  username: \"mailmarketme@mbox.contact.bg\",\n  password: \"09730Success\"\n});\n\nfunction findEmailAddresses(StrObj) {\n  var separateEmailsBy = \", \";\n  var email = \"<none>\"; // if no match, use this\n\n  var emailsArray = StrObj.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\\\.[a-zA-Z0-9._-]+)/gi);\n\n  if (emailsArray) {\n    email = \"\";\n\n    for (var i = 0; i < emailsArray.length; i++) {\n      if (i != 0) email += separateEmailsBy;\n      email += emailsArray[i];\n    }\n  }\n\n  return email;\n}\n\nfunction shuffle(array) {\n  var currentIndex = array.length,\n      temporaryValue,\n      randomIndex; // While there remain elements to shuffle...\n\n  while (0 !== currentIndex) {\n    // Pick a remaining element...\n    randomIndex = Math.floor(Math.random() * currentIndex);\n    currentIndex -= 1; // And swap it with the current element.\n\n    temporaryValue = array[currentIndex];\n    array[currentIndex] = array[randomIndex];\n    array[randomIndex] = temporaryValue;\n  }\n\n  return array;\n}\n\nexport default ((req, res) => {\n  let mailArray = [0];\n  client.connect(err => {\n    const db = client.db(\"MailMarketMe\");\n    let mailsToSend = db.collection(\"emails\").find({});\n    mailsToSend.toArray().then(result => {\n      for (let i = 0; i <= req.body.pointsToUse; i++) {\n        console.log(result[i].email);\n        mailArray.push(result[i].email);\n      }\n    });\n  });\n  mailArray[0]++;\n\n  if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n    client.connect(err => {\n      if (err) throw err;\n      const db = client.db(\"MailMarketMe\");\n      db.collection(\"accounts\").findOne({\n        _id: mongodb.ObjectId(Base64.decode(req.body.id))\n      }, (err, result) => {\n        if (req.body.pointsToUse <= result.points) {\n          db.collection(\"accounts\").updateOne({\n            _id: mongodb.ObjectId(Base64.decode(req.body.id))\n          }, {\n            $set: {\n              points: result.points - req.body.pointsToUse,\n              totalEmailsSent: parseInt(req.body.pointsToUse) + parseInt(result.totalEmailsSent)\n            }\n          }, err => {\n            if (err) throw err;\n          });\n\n          for (let i = 0; i < req.body.pointsToUse; i++) {\n            let data = mailArray[i];\n            console.log(data);\n          }\n\n          ; // Send the emails \n\n          res.status(200).end();\n        } else {\n          res.status(406).end();\n        }\n      });\n    });\n  } else {\n    res.status(406).end();\n  }\n});","map":{"version":3,"sources":["/Users/mac/Desktop/Web Apps/MailMarket.me/mailmarket.me/pages/api/mailer.js"],"names":["Base64","mongodb","simplesmtp","MongoClient","uri","client","useNewUrlParser","useUnifiedTopology","mailerClient","Mail","host","port","secure","username","password","findEmailAddresses","StrObj","separateEmailsBy","email","emailsArray","match","i","length","shuffle","array","currentIndex","temporaryValue","randomIndex","Math","floor","random","req","res","mailArray","connect","err","db","mailsToSend","collection","find","toArray","then","result","body","pointsToUse","console","log","push","method","id","undefined","customEmailList","msgToSend","from","findOne","_id","ObjectId","decode","points","updateOne","$set","totalEmailsSent","parseInt","data","status","end"],"mappings":"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","sourcesContent":["import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\n\nconst client = new MongoClient(uri, { useNewUrlParser: true, useUnifiedTopology: true });\n\nconst mailerClient = simplesmtp.Mail({\n    host: \"mbox.contact.bg\",\n    port: 25,\n    secure: false,\n    username: \"mailmarketme@mbox.contact.bg\",\n    password: \"09730Success\",\n})\n\nfunction findEmailAddresses(StrObj) {\n    var separateEmailsBy = \", \";\n    var email = \"<none>\"; // if no match, use this\n    var emailsArray = StrObj.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\\\.[a-zA-Z0-9._-]+)/gi);\n    if (emailsArray) {\n        email = \"\";\n        for (var i = 0; i < emailsArray.length; i++) {\n            if (i != 0) email += separateEmailsBy;\n            email += emailsArray[i];\n        }\n    }\n    return email;\n}\n\nfunction shuffle(array) {\n    var currentIndex = array.length, temporaryValue, randomIndex;\n\n    // While there remain elements to shuffle...\n    while (0 !== currentIndex) {\n\n        // Pick a remaining element...\n        randomIndex = Math.floor(Math.random() * currentIndex);\n        currentIndex -= 1;\n\n        // And swap it with the current element.\n        temporaryValue = array[currentIndex];\n        array[currentIndex] = array[randomIndex];\n        array[randomIndex] = temporaryValue;\n    }\n\n    return array;\n}\n\n\nexport default (req, res) => {\n    let mailArray = [0];\n    client.connect(err => {\n        const db = client.db(\"MailMarketMe\");\n        let mailsToSend = db.collection(\"emails\").find({});\n        mailsToSend.toArray().then(result => {\n            for (let i = 0; i <= req.body.pointsToUse; i++) {\n                console.log(result[i].email);\n                mailArray.push(result[i].email);\n            }\n        });\n    });\n    mailArray[0]++;\n\n    if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n        client.connect(err => {\n            if (err) throw err;\n            const db = client.db(\"MailMarketMe\");\n            db.collection(\"accounts\").findOne({ _id: mongodb.ObjectId(Base64.decode(req.body.id)) }, (err, result) => {\n                if (req.body.pointsToUse <= result.points) {\n                    db.collection(\"accounts\").updateOne({ _id: mongodb.ObjectId(Base64.decode(req.body.id)) },\n                        {\n                            $set: {\n                                points: result.points - req.body.pointsToUse,\n                                totalEmailsSent: parseInt(req.body.pointsToUse) + parseInt(result.totalEmailsSent)\n                            }\n                        },\n                        err => { if (err) throw err }\n                    );\n\n\n                    for(let i = 0; i < req.body.pointsToUse; i++){\n                            let data = mailArray[i]\n                            console.log(data);\n                    };\n\n                    // Send the emails \n                    res.status(200).end();\n                } else {\n                    res.status(406).end();\n                }\n            });\n        });\n    }\n    else {\n        res.status(406).end();\n    }\n}"]},"metadata":{},"sourceType":"module"}