{"ast":null,"code":"import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\nconst client = new MongoClient(uri, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\nconst mailerClient = simplesmtp.Mail({\n  host: \"mbox.contact.bg\",\n  port: 25,\n  secure: false,\n  username: \"mailmarketme@mbox.contact.bg\",\n  password: \"09730Success\"\n});\n\nfunction findEmailAddresses(StrObj) {\n  var separateEmailsBy = \", \";\n  var email = \"<none>\"; // if no match, use this\n\n  var emailsArray = StrObj.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\\\.[a-zA-Z0-9._-]+)/gi);\n\n  if (emailsArray) {\n    email = \"\";\n\n    for (var i = 0; i < emailsArray.length; i++) {\n      if (i != 0) email += separateEmailsBy;\n      email += emailsArray[i];\n    }\n  }\n\n  return email;\n}\n\nfunction shuffle(array) {\n  var currentIndex = array.length,\n      temporaryValue,\n      randomIndex; // While there remain elements to shuffle...\n\n  while (0 !== currentIndex) {\n    // Pick a remaining element...\n    randomIndex = Math.floor(Math.random() * currentIndex);\n    currentIndex -= 1; // And swap it with the current element.\n\n    temporaryValue = array[currentIndex];\n    array[currentIndex] = array[randomIndex];\n    array[randomIndex] = temporaryValue;\n  }\n\n  return array;\n}\n\nlet mailArray = [];\nclient.connect(err => {\n  const db = client.db(\"MailMarketMe\");\n  let mailsToSend = db.collection(\"emails\").find({});\n  console.log(req.body.customEmailList);\n  mailsToSend.toArray().then(res => {\n    res = shuffle(res);\n\n    for (let i = 0; i <= req.body.pointsToUse; i++) {\n      mailArray.push(res[i].email);\n    }\n\n    mailArray.forEach(data => {\n      mailerClient.message({\n        from: req.body.from,\n        to: data,\n        subject: req.body.subject,\n        \"Content-type\": \"text/html\"\n      }).body(req.body.msgToSend).send(err => {\n        if (err) console.log(err);\n      });\n    });\n  });\n});\nexport default ((req, res) => {\n  if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n    client.connect(err => {\n      if (err) throw err;\n      const db = client.db(\"MailMarketMe\");\n      db.collection(\"accounts\").findOne({\n        _id: mongodb.ObjectId(Base64.decode(req.body.id))\n      }, (err, result) => {\n        if (req.body.pointsToUse <= result.points) {\n          db.collection(\"accounts\").updateOne({\n            _id: mongodb.ObjectId(Base64.decode(req.body.id))\n          }, {\n            $set: {\n              points: result.points - req.body.pointsToUse,\n              totalEmailsSent: parseInt(req.body.pointsToUse) + parseInt(result.totalEmailsSent)\n            }\n          }, err => {\n            if (err) throw err;\n          });\n          let mailsToSend = db.collection(\"emails\").find({});\n          console.log(req.body.customEmailList);\n          mailsToSend.toArray().then(res => {\n            mailArray = shuffle(mailArray.concat(req.body.customEmailList, mailArray));\n\n            for (let i = 0; i < req.body.pointsToUse; i++) {\n              let data = mailArray[i].email;\n              console.log(data);\n            }\n          }); // Send the emails \n\n          res.status(200).end();\n        } else {\n          res.status(406).end();\n        }\n      });\n    });\n  } else {\n    res.status(406).end();\n  }\n});","map":{"version":3,"sources":["/Users/mac/Desktop/Web Apps/MailMarket.me/mailmarket.me/pages/api/mailer.js"],"names":["Base64","mongodb","simplesmtp","MongoClient","uri","client","useNewUrlParser","useUnifiedTopology","mailerClient","Mail","host","port","secure","username","password","findEmailAddresses","StrObj","separateEmailsBy","email","emailsArray","match","i","length","shuffle","array","currentIndex","temporaryValue","randomIndex","Math","floor","random","mailArray","connect","err","db","mailsToSend","collection","find","console","log","req","body","customEmailList","toArray","then","res","pointsToUse","push","forEach","data","message","from","to","subject","msgToSend","send","method","id","undefined","findOne","_id","ObjectId","decode","result","points","updateOne","$set","totalEmailsSent","parseInt","concat","status","end"],"mappings":"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","sourcesContent":["import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\n\nconst client = new MongoClient(uri, { useNewUrlParser: true, useUnifiedTopology: true });\n\nconst mailerClient = simplesmtp.Mail({\n    host: \"mbox.contact.bg\",\n    port: 25,\n    secure: false,\n    username: \"mailmarketme@mbox.contact.bg\",\n    password: \"09730Success\",\n})\n\nfunction findEmailAddresses(StrObj) {\n    var separateEmailsBy = \", \";\n    var email = \"<none>\"; // if no match, use this\n    var emailsArray = StrObj.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\\\.[a-zA-Z0-9._-]+)/gi);\n    if (emailsArray) {\n        email = \"\";\n        for (var i = 0; i < emailsArray.length; i++) {\n            if (i != 0) email += separateEmailsBy;\n            email += emailsArray[i];\n        }\n    }\n    return email;\n}\n\nfunction shuffle(array) {\n    var currentIndex = array.length, temporaryValue, randomIndex;\n\n    // While there remain elements to shuffle...\n    while (0 !== currentIndex) {\n\n        // Pick a remaining element...\n        randomIndex = Math.floor(Math.random() * currentIndex);\n        currentIndex -= 1;\n\n        // And swap it with the current element.\n        temporaryValue = array[currentIndex];\n        array[currentIndex] = array[randomIndex];\n        array[randomIndex] = temporaryValue;\n    }\n\n    return array;\n}\n\nlet mailArray = [];\nclient.connect(err => {\n    const db = client.db(\"MailMarketMe\");\n    let mailsToSend = db.collection(\"emails\").find({});\n    console.log(req.body.customEmailList);\n    mailsToSend.toArray().then(res => {\n        res = shuffle(res);\n        for (let i = 0; i <= req.body.pointsToUse; i++) {\n            mailArray.push(res[i].email);\n        }\n\n        mailArray.forEach(data => {\n            mailerClient.message({\n                from: req.body.from,\n                to: data,\n                subject: req.body.subject,\n                \"Content-type\": \"text/html\",\n            }).body(req.body.msgToSend).send(err => { if (err) console.log(err) });\n        })\n    });\n});\n\nexport default (req, res) => {\n    if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n        client.connect(err => {\n            if (err) throw err;\n            const db = client.db(\"MailMarketMe\");\n            db.collection(\"accounts\").findOne({ _id: mongodb.ObjectId(Base64.decode(req.body.id)) }, (err, result) => {\n                if (req.body.pointsToUse <= result.points) {\n                    db.collection(\"accounts\").updateOne({ _id: mongodb.ObjectId(Base64.decode(req.body.id)) },\n                        {\n                            $set: {\n                                points: result.points - req.body.pointsToUse,\n                                totalEmailsSent: parseInt(req.body.pointsToUse) + parseInt(result.totalEmailsSent)\n                            }\n                        },\n                        err => { if (err) throw err }\n                    );\n\n                    let mailsToSend = db.collection(\"emails\").find({});\n                    console.log(req.body.customEmailList);\n                    mailsToSend.toArray().then(res => {\n                        mailArray = shuffle(mailArray.concat(req.body.customEmailList, mailArray));\n                        for(let i = 0; i < req.body.pointsToUse; i++){\n                            let data = mailArray[i].email\n                            console.log(data);\n                        }\n                    });\n\n                    // Send the emails \n                    res.status(200).end();\n                } else {\n                    res.status(406).end();\n                }\n            });\n        });\n    }\n    else {\n        res.status(406).end();\n    }\n}"]},"metadata":{},"sourceType":"module"}