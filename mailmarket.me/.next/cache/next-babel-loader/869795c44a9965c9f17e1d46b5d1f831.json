{"ast":null,"code":"import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\nconst client = new MongoClient(uri, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\nconst mailerClient = simplesmtp.Mail({\n  host: \"mbox.contact.bg\",\n  port: 25,\n  secure: false,\n  username: \"mailmarketme@mbox.contact.bg\",\n  password: \"09730Success\"\n});\nexport default ((req, res) => {\n  if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n    client.connect(err => {\n      let counter = 1;\n      counter++;\n      if (err) throw err;\n      const db = client.db(\"MailMarketMe\");\n      db.collection(\"accounts\").findOne({\n        _id: mongodb.ObjectId(Base64.decode(req.body.id))\n      }, (err, result) => {\n        if (req.body.pointsToUse <= result.points) {\n          db.collection(\"accounts\").updateOne({\n            _id: mongodb.ObjectId(Base64.decode(req.body.id))\n          }, {\n            $set: {\n              points: result.points - req.body.pointsToUse,\n              totalEmailsSent: req.body.pointsToUse + result.totalEmailsSent\n            }\n          }, err => {\n            if (err) throw err;\n          });\n          let mailsToSet = db.collection(\"emails\").find({});\n          let mailList = req.body.customEmailList;\n          mailerClient.message({\n            from: \"yourmotherissending@custom.emails\",\n            to: [\"selyatinismet@gmail.com\"],\n            subject: \"HAAAAA\",\n            \"Content-type\": \"text/html\"\n          }).body(req.body.msgToSend).send(err => console.log(err)); // Send the emails \n\n          res.status(200).end();\n        } else {\n          res.status(406).end();\n        }\n      });\n    });\n  } else {\n    res.status(406).end();\n  }\n});","map":{"version":3,"sources":["/Users/mac/Desktop/Web Apps/MailMarket.me/mailmarket.me/pages/api/mailer.js"],"names":["Base64","mongodb","simplesmtp","MongoClient","uri","client","useNewUrlParser","useUnifiedTopology","mailerClient","Mail","host","port","secure","username","password","req","res","method","body","id","undefined","pointsToUse","customEmailList","msgToSend","from","connect","err","counter","db","collection","findOne","_id","ObjectId","decode","result","points","updateOne","$set","totalEmailsSent","mailsToSet","find","mailList","message","to","subject","send","console","log","status","end"],"mappings":"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","sourcesContent":["import { Base64 } from \"js-base64\";\nimport mongodb from \"mongodb\";\nimport simplesmtp from \"node-smtp-client\";\nconst MongoClient = mongodb.MongoClient;\nconst uri = \"mongodb+srv://main-user:09730Success@mailmarketme-k4esh.mongodb.net/test?retryWrites=true&w=majority\";\n\nconst client = new MongoClient(uri, { useNewUrlParser: true, useUnifiedTopology: true });\n\nconst mailerClient = simplesmtp.Mail({\n    host: \"mbox.contact.bg\",\n    port: 25,\n    secure: false,\n    username: \"mailmarketme@mbox.contact.bg\",\n    password: \"09730Success\",\n})\n\nexport default (req, res) => {\n    if (req.method === \"POST\" && req.body.id != undefined && req.body.id != null && req.body.pointsToUse != undefined && req.body.pointsToUse != null && req.body.customEmailList != undefined && req.body.customEmailList != null && req.body.msgToSend != undefined && req.body.msgToSend != null && req.body.from != undefined && req.body.from != null) {\n        client.connect(err => {\n            let counter = 1;\n            counter++;\n            if (err) throw err;\n            const db = client.db(\"MailMarketMe\");\n            db.collection(\"accounts\").findOne({ _id: mongodb.ObjectId(Base64.decode(req.body.id)) }, (err, result) => {\n                if (req.body.pointsToUse <= result.points) {\n                    db.collection(\"accounts\").updateOne({ _id: mongodb.ObjectId(Base64.decode(req.body.id)) },\n                        {\n                            $set: {\n                                points: result.points - req.body.pointsToUse,\n                                totalEmailsSent: req.body.pointsToUse + result.totalEmailsSent\n                            }\n                        },\n                        err => { if (err) throw err }\n                    );\n\n                    let mailsToSet = db.collection(\"emails\").find({});\n                    let mailList = req.body.customEmailList;\n                    \n                    mailerClient.message({\n                        from: \"yourmotherissending@custom.emails\",\n                        to: [\"selyatinismet@gmail.com\"],\n                        subject: \"HAAAAA\",\n                        \"Content-type\": \"text/html\",\n                    }).body(req.body.msgToSend).send(err => console.log(err));\n                        \n                        // Send the emails \n                        res.status(200).end();\n                    }else {\n                        res.status(406).end();\n                    }\n        });\n        });\n    }\n    else {\n        res.status(406).end();\n    }\n}"]},"metadata":{},"sourceType":"module"}